<% content_for :head do %>
  <%= stylesheet_link_tag "plot_bubble" -%>
<% end %>

<div id="center">
  
  <div id="text">
        <! %= @associations.to_s %>
  </div>

  <div id="fig">


  <script type="text/javascript+protovis">
    

    var xselect = 'cvalue != undefined';
    var yselect = 'value >= 0';
      var data = '<%= @associations.to_s%>'.evalJSON();


      //var data = dataJson.evalJSON();
//      alert(data.experiments);
//      data.experiments.each(function(d) {alert(nodeFromArray(d.phenotypes, "cvalue != undefined").cvalue.name + "!")});


      dataMap = data.experiments.map(function(d) {return {x: nodeFromArray(d.phenotypes, xselect).cvalue.name, y: nodeFromArray(d.phenotypes, yselect).value}})

      xcats = dataMap.map(function(d) {return d.x}).uniq();

	alert(data.x);
      /* Sizing and scales. */
      var w = 500,
          h = 500,
	  x = pv.Scale.ordinal(xcats).split(0, w)
    	  y = pv.Scale.linear(0, 500).range(0, h).nice(),
	  s = x.range().band / 2;
	  c = pv.Colors.category10();

 /* The root panel. */
    var vis = new pv.Panel()
         .width(w)
    	 .height(h)
  	 .bottom(20)
    	 .left(20)
    	 .right(10)
    	 .top(5);

 /* Y-axis and ticks. */
    vis.add(pv.Rule)
	.data(y.ticks())
   	.bottom(y)
    	.strokeStyle(function(d) d ? "#eee" : "#000")
  	.anchor("left").add(pv.Label)
//    	.visible(function(d) d % 0.1 == 0 || d % 10 == 0)
    	.text(y.tickFormat)
	;

/* X-axis and ticks. 
    vis.add(pv.Rule)
	.data(xcats)
	.left(x)
	.anchor("bottom").add(pv.Label)
//    	
;

/* The dot plot! */
//     points.add(pv.Dot)
     panel = vis.add(pv.Panel)
       .data(data.experiments.sort(function(d) {nodeFromArray(d.phenotypes, "value >= 0").value}))
       ;

//     var dots = new Array();
     dots = panel.add(pv.Dot)
/*   change zeros to 0.1 for log scale */
//    	    .bottom(function(d) y((nodeFromArray(d.phenotypes, "value >= 0").value == 0)?0.1:nodeFromArray(d.phenotypes, "value >= 0").value) )
    	    .bottom(function(d) y(nodeFromArray(d.phenotypes, "value >= 0").value) )
	    .left(function(d) x(d.phenotypes[1].cvalue.name))
	    .strokeStyle(function(d) c(d.phenotypes[1].cvalue.name))
	;

	alert(panel.children.length + " "+ panel.children[0].type);
	alert(data.type +" "+ data.map);
//     dots.sort(function(d) {d.bottom});
/*     for(var i = 0; i <= dots.data.experiments.length; i++) {
     	alert(dots.data.type);
	pv.search(dots)
     }
*/
    vis.render();   

    </script>
  </div>
</div>
